{% load static %}
<html>
   <head>
      <title>Results</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
    </script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.1/jquery.validate.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    </script>
   </head>
   <style type="text/css">
   thead{
  background-color: #E15730; color: white;
  }
  td, th {
  border: 1px solid #dddddd;
  text-align: center;;
  padding: 8px;
}
#tag{
  font-weight: bolder;
    font-size: x-large;
    color: #E15730;
}
	   
.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  position:absolute;
  top:45%;
  left:45%;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
}

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.container{
  width: 90%;
  margin:5% auto;
  display: none;
}
.card{
  margin:1%;
  margin-bottom: 5%;
}

</style>
   <body>
     
      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
      {% csrf_token %} 
      {% if table_name %}
      <nav style="background-color:#E15730;">
            <div class="nav-wrapper">
                <!--<a href="#" class="brand-logo right"><img src="{% static 'images/logo.png' %}" alt="AKIRA"/></a>-->
                <a href="#" class="brand-logo right">AKIRA
				</a>
            </div>
        </nav>
        <center><p id='tag'><b>Report for {{ table_name }}</b></p></center>
        <div class="container">
          <div class="card" style="height: 350px; width: 600px;float:left;padding-top:1%">
            <canvas id="bar"></canvas>
          </div>
          <div class="card" style="height: 350px; width: 600px;float:left;padding-top:1%">
            <canvas id="pie"></canvas>
          </div>
        </div>
        <div class="row"></div>
        <div id="result_table" class="col s8" style="overflow-x: scroll; margin-left:5%; margin-right:5%;float: none;margin-bottom:5%">
      <table  id="procResults" class="responsive-table centered striped">
      <thead>
        <tr>
      <th>TBL_NAME</th>
    <th>COL_NAME</th>
    <th>COL_DATA_LENGTH</th>
    <th>COL_DATE_TYPE</th>
    <th>COL_MIN_DATA_LENGTH</th>
    <th>COL_MAX_DATA_LENGTH</th>
    <th>COL_AVG_DATA_LENGTH</th>
    <th>COL_MIN_DATE</th>
    <th>COL_MAX_DATE</th>
    <th>COL_DISTINCT_CNT</th>
    <th>COL_NULLS_CNT</th>
    <th>COL_EMPTY_CNT</th>
    <th>COL_NULLS_PERCENTAGE</th>
    <th>COL_EMPTY_PERCENTAGE</th>
    <th>COL_FK</th>
    <th>COL_DATA_TYPE_RECOMMEND</th>

      </tr>
      </thead>
        <tbody id="procResultsTabBody"></tbody>
      </table>
      </div>
      <div class="loader center-align"></div>
      
   </body>

{% else %}
<p>No dbnames Available
</p>
{% endif %}
<script type="text/javascript">
   $( document ).ready(function() {
    // var obj = {'report_array': table_name}
    $("#result_table").hide();
                $("#procResults").hide();
        $.ajax({
            url: '/runProcedure/',
            data: {
                'table_name': "{{ table_name }}"
            },
            type: 'GET',
            dataType: 'json',
            success: function(data) {
              // alert("success");
            $("#procResultsTabBody").empty();
              var name = [];
              var n_per = [];
              var n_count = [];
              var total=0;
                for (let i = 0; i < data.data.length; i++) {
                var row = "<tr>";
                $("#procResultsTabBody").append("<tr>");
                 for (let j = 0; j < data.data[i].length; j++){
                 row = row +"<td>" + data.data[i][j] + "</td>";
                 if(j==1){
                   name.push(data.data[i][j]);
                 }else if(j==10){
                   n_count.push(parseFloat(data.data[i][j]));
                   total=total+parseFloat(data.data[i][j]);
                 }else if(j==12){
                   n_per.push(parseFloat(data.data[i][j]));
                 }

                 /*$("#procResultsTabBody").append("<td>" + data.data[i][j] + "</td>");*/
                 }
                 /*$("#procResultsTabBody").append("</tr>");*/
                 row = row + "</tr>";
                 $("#procResultsTabBody").append(row);

                }
                $("#result_table").show();
                $("#procResults").show();
                $('.loader').hide();
                console.log(name,n_count,n_per,total);
                $('.container').show();
                barChart(name,n_per);
                pieChart(name,n_count,total);
            }
        });
        

  });

    function pieChart(name,count,total) {
      var c=[];
      for(i=0;i<name.length;i++){
        c.push(count[i]/total);
      }
      var ctx_p = document.getElementById('pie').getContext('2d');
      var chart_p = new Chart(ctx_p, {
        // The type of chart we want to create
        type: 'pie',

        // The data for our dataset
        data: {
          labels: name,
          datasets: [{
            label: 'Null count share',
            backgroundColor: ['rgba(255, 99, 132, 0.2)',
              'rgba(54, 162, 235, 0.2)',
              'rgba(255, 206, 86, 0.2)',
              'rgba(75, 192, 192, 0.2)',],
            borderColor: ['rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)'],
            borderWidth: 2,
            data: c
          }]
        },

        // Configuration options go here
        options: {
          title: {
            display: true,
            text: 'Pie Chart - Null Count Share',
            fontSize: 20
          },
          legend: {
            position: 'bottom'
          }
        }
      });
    }

    

    function barChart(name,per){
      var ctx = document.getElementById('bar').getContext('2d');
      var chart = new Chart(ctx, {
        // The type of chart we want to create
        type: 'bar',

        // The data for our dataset
        data: {
          labels: name,
          datasets: [{
            label: 'Null Percentage',
            backgroundColor: ['rgba(255, 99, 132, 0.2)',
              'rgba(54, 162, 235, 0.2)',
              'rgba(255, 206, 86, 0.2)',
              'rgba(75, 192, 192, 0.2)',],
            borderColor: ['rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)'],
            borderWidth: 2,
            data : per,
          }]
        },

        // Configuration options go here
        options: {
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              },
              gridLines:{
                display:false
              },
              scaleLabel: {
                display: true,
                labelString: 'Null Percentage'
              }
            }],
            xAxes:[{
              gridLines: {
                display:false
              }
            }]
          },
          legend:{
            position:'bottom',
          },
          title: {
            display: true,
            text: 'Bar Graph - Null Percentage',
            fontSize: 20
          }
        }
      });
    }
      
   </script>
   
</html>
